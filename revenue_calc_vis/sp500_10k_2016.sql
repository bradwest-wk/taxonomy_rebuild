-- Queries datapoint values for Income Statement datapoints for 10-K S&P 500
-- filers. Uses aspect_value_selection_id = NULL to select only those facts
-- that are not dimensionalized (no axis/member have been applied).  Period
-- must be for 12 months.

SELECT DISTINCT ON (rb.company_name, a.name)
rb.company_name,
rb.cik,
rb.form_type,
tdp.table_code,
a.name,
rb.filing_date,
dp.value,
p.start_date,
p.end_date
FROM _mv_research_base_2014_ongoing rb
JOIN data_point dp ON dp.report_id = r.report_id
JOIN aspect a ON a.aspect_id = dp.aspect_id
JOIN period p ON p.period_id = dp.period_id
JOIN table_data_points tdp ON tdp.datapoint_id = dp.datapoint_id
WHERE rb.filing_date >= '2016-01-01' AND rb.filing_date < '2017-01-01' 
AND rb.form_type LIKE '10-K%'
-- We are missing some values because of this aspect_value_selection_id criteria
-- In R: sp500_gaap_rev[is.na(sp500_gaap_rev$value),]
AND dp.aspect_value_selection_id IS NULL
AND ((DATE_PART('year', p.end_date) - DATE_PART('year', p.start_date)) * 12 +
              (DATE_PART('month', p.end_date) - DATE_PART('month', p.start_date))) = 12
AND tdp.table_code = 'IS'
-- cik list from framework analysis Revenue Analysis Round 2 S&P 500
AND rb.cik IN ('0000066740','0000001800','0001551152','0001467373','0000718877','0001144215','0000796343',
'0001158449','0000874761','0001122304','0001004434','0000004977','0001090872','0000002969','0001086222',
'0000915913','0000004281','0000899866','0001579241','0001578845','0001101215','0000352541','0000899051',
'0001652044','0000764180','0001018724','0001002910','0000006201','0000004904','0000004962','0000005272',
'0001053507','0001410636','0000820027','0001140859','0001037868','0000318154','0000820313','0000773910',
'0000006281','0001156039','0000315293','0000006769','0000922864','0000320193','0000006951','0000007084',
'0001267238','0000732717','0000769397','0000008670','0000350698','0000866787','0000915912','0000008818',
'0000808362','0000009389','0000070858','0001390777','0000009892','0000010456','0000092230','0000010795',
'0000886158','0001067983','0000764478','0000875045','0001364742','0000012927','0000908255','0001037540',
'0000885725','0000014272','0001649338','0000014693','0001043277','0000356028','0000858470','0000016732',
'0000927628','0000721371','0001170010','0000815097','0000018230','0001138118','0000813828','0000816284',
'0001071739','0001130310','0000018926','0000804753','0001324404','0000895126','0000093410','0001058090',
'0000896159','0000313927','0000701221','0001168054','0000020286','0000723254','0000858877','0000831001',
'0000759944','0000877890','0000021076','0001156375','0000811156','0001116132','0000021344','0001058290',
'0000021665','0001166691','0000028412','0000023217','0001358071','0001163165','0001047862','0000016918',
'0000024741','0000909832','0001051470','0000277948','0000026172','0000064803','0000313616','0000940944',
'0000927066','0000315189','0001521332','0000027904','0000818479','0001090012','0000949039','0001297996',
'0001393612','0001437107','0000029534','0000935703','0000715957','0000029905','0000029915','0001418135',
'0000936340','0001326160','0001115222','0000030554','0001015780','0000915389','0001551182','0001065088',
'0000031462','0000827052','0001099800','0000712515','0000790070','0000032604','0001593034','0000065984',
'0000821189','0000033213','0000033185','0001101239','0000906107','0000920522','0001001250','0000072741',
'0001109357','0001324424','0000746515','0001532063','0001289490','0000034088','0001048695','0001326801',
'0000815556','0000034903','0001048911','0001136893','0000035527','0001274494','0001031296','0000798354',
'0000354908','0000030625','0001124198','0000037785','0001135152','0000850209','0000037996','0001519751',
'0000038777','0000831259','0000020520','0000354190','0000039911','0001121788','0000040533','0000040545',
'0001496048','0000040704','0001467858','0000040987','0000882095','0001123360','0000886982','0000042582',
'0000277135','0000012659','0000315213','0000045012','0001359841','0000793952','0000800459','0000202058',
'0000874766','0000046080','0000860730','0000765880','0000046765','0001000228','0000047111','0000004447',
'0001645590','0000859737','0000354950','0000773840','0000048465','0000882184','0001070750','0000047217',
'0000049071','0000728535','0000049196','0000049826','0001110803','0001466258','0000050863','0001571949',
'0000051143','0000051253','0000051434','0000051644','0000896878','0001035267','0000914208','0001020569',
'0000091419','0000052988','0000200406','0000053669','0000019617','0001043604','0000054480','0000055067',
'0000091576','0000055785','0000879101','0001506307','0000319201','0000885639','0001637459','0000056873',
'0001056239','0000701985','0000920148','0000707549','0000704051','0000058492','0000920760','0000096223',
'0000794323','0000059478','0000059558','0000791907','0001065696','0000936468','0000060086','0000060667',
'0001489393','0000036270','0000912242','0000794367','0001567892','0000101778','0001510295','0001048286',
'0000062709','0000916076','0000062996','0001141391','0000063276','0000063754','0000063908','0000927653',
'0001452575','0001613103','0000310158','0001099219','0001530721','0000827054','0000723125','0000789019',
'0000851968','0000024545','0001103982','0001110783','0000865752','0001059556','0000895421','0001285785',
'0000068505','0000717423','0001623613','0001120193','0001021860','0001593538','0001002047','0001065280',
'0000814453','0000912750','0001164727','0001564708','0000753308','0001492633','0000320187','0001111711',
'0000072207','0000072333','0000702165','0000073124','0001133421','0001013871','0000073309','0001045810',
'0000898173','0000797468','0000029989','0001039684','0001341439','0000812074','0000075362','0000076334',
'0000891024','0000723531','0001633917','0000077360','0001378946','0000077476','0000031791','0001585364',
'0000078003','0001004980','0001413329','0001534701','0000764622','0001038357','0000078814','0000713676',
'0000079879','0000922224','0000884905','0001113169','0001075531','0001126328','0000080424','0000080661',
'0001045609','0001137774','0000788784','0001393311','0000822416','0000078239','0000804328','0001604778',
'0001050915','0001022079','0001037038','0000315852','0001047122','0000726728','0001087423','0000872589',
'0001281761','0001060391','0001275283','0001024478','0001137411','0000882835','0000745732','0000884887',
'0000085961','0000064040','0001108524','0001000180','0000754737','0000087347','0000316709','0001430602',
'0001137789','0001012100','0001032208','0000089800','0000832988','0001063761','0001040971','0000004127',
'0000091440','0000092122','0000092380','0000007332','0001373835','0000203077','0000093556','0000791519',
'0000829224','0000316206','0000093751','0000861878','0000310764','0000750556','0000849399','0001601712',
'0000096021','0000027419','0001385157','0000039899','0000816761','0000050104','0000097476','0000217346',
'0000097745','0000098246','0001105705','0000109198','0000320335','0000721683','0000916365','0001260221',
'0001451505','0000086312','0001526520','0001308161','0000833444','0000100493','0000074208','0001403568',
'0001336917','0000100885','0000100517','0001090727','0001067701','0000101829','0000731766','0000352915',
'0000912615','0000005513','0000036104','0000103379','0001035002','0000203527','0000740260','0001014473',
'0001442145','0000732712','0000875320','0001339947','0001403161','0000899689','0001396009','0000104169',
'0001618921','0001001039','0000823768','0001000697','0000783325','0000072971','0000766704','0000106040',
'0001365135','0001636023','0000106535','0000106640','0000865436','0000107263','0001140536','0001361658',
'0001174922','0000072903','0000108772','0000743988','0000875159','0001524472','0001011006','0001041061',
'0001136869','0000109380','0001555280')
ORDER BY company_name,
name,
p.end_date DESC;

SELECT DISTINCT form_type FROM _mv_research_base_2014_ongoing ORDER BY form_type;

-- Investigate why missing 3.5% of data because of aspect_value_selection_id IS NULL
SELECT DISTINCT -- DISTINCT ON (rb.company_name, a.name)
rb.company_name,
rb.cik,
rb.form_type,
tdp.table_code,
a.name AS element_name,
avs_n.axis_member_names, 
avs_n.axis_member_source,
dp.aspect_value_selection_id,
-- avs.aspect_value_selection_id,
-- avs.aspect_value_id,
-- avs.is_typed_value,
-- avs.typed_value,
rb.filing_date,
dp.value,
p.start_date,
p.end_date
FROM _mv_research_base_2014_ongoing rb
JOIN data_point dp ON dp.report_id = rb.report_id
JOIN aspect a ON a.aspect_id = dp.aspect_id
JOIN period p ON p.period_id = dp.period_id
JOIN table_data_points tdp ON tdp.datapoint_id = dp.datapoint_id
LEFT OUTER JOIN _mv_axis_member_pairs avs_n on dp.aspect_value_selection_id=avs_n.aspect_value_selection_id
WHERE rb.filing_date >= '2016-01-01' AND rb.filing_date < '2017-01-01' 
AND rb.form_type LIKE '10-K%'
-- We are missing some values because of this aspect_value_selection_id criteria
-- In R: sp500_gaap_rev[is.na(sp500_gaap_rev$value),]
-- AND dp.aspect_value_selection_id IS NULL
AND ((DATE_PART('year', p.end_date) - DATE_PART('year', p.start_date)) * 12 +
              (DATE_PART('month', p.end_date) - DATE_PART('month', p.start_date))) = 12
AND tdp.table_code = 'IS'
AND rb.cik IN ('0000004904', '0000004904', '0001390777','0001390777', '0001390777', '0001390777', '0001390777', '0001067983', '0001067983', '0001364742', '0001364742', '0001364742', '0001364742',
'0001364742', '0001364742', '0001170010', '0000016918', '0001051470', '0001051470', '0001051470', '0000927066', '0001326160', '0001326160', '0001326160', '0001326160', '0001101239',
'0001101239', '0001109357', '0001326801', '0001326801', '0001496048', '0001496048', '0001496048', '0001496048', '0001496048', '0000882184', '0000882184', '0000882184', '0000882184',
'0000047217', '0000047217', '0000047217', '0001637459', '0000704051', '0000704051', '0000704051', '0000704051', '0000704051', '0000920760', '0000920760', '0000920760','0000912750'
'0000075362','0000075362','0000075362','0000075362','0001585364','0000922224','0000922224','0000922224','0000872589','0000872589','0000872589','0000872589','0001040971'
'0000833444')
AND a.name IN ('RevenueFromRelatedParties','RelatedPartyTransactionOtherRevenuesFromTransactionsWithRelatedParty','ClearingFeesRevenue','AssetManagementFees1','MarketableSecuritiesRealizedGainLossOtherThanTemporaryImpairmentsAmount','InterestExpenseOther','InvestmentIncomeNet','PremiumsEarnedNet','GainLossOnDerivativeInstrumentsNetPretax','InvestmentAdvisoryFees','PerformanceFees','RevenueOtherFinancialServices','DistributionAndServicingFees','OtherIncome','RevenuesExcludingInterestAndDividends','OtherSalesRevenueNet','SalesRevenueGoodsNet','OperatingLeasesIncomeStatementLeaseRevenue','SalesRevenueServicesNet','SalesRevenueNet','Revenues','ElectricDomesticRegulatedRevenue','UnregulatedOperatingRevenue','GasDomesticRegulatedRevenue','SalesRevenueNet','OperatingLeasesIncomeStatementLeaseRevenue','ManagementFeesRevenue','ElectricalTransmissionAndDistributionRevenue','AdvertisingRevenue','OtherSalesRevenueNet','OperatingLeasesIncomeStatementMinimumLeaseRevenue','TenantReimbursements','OperatingLeasesIncomeStatementContingentRevenue','OtherIncome','Revenues','HomeBuildingRevenue','LandSales','RealEstateRevenueNet','FinancialServicesRevenue','SalesRevenueGoodsNet','SalesRevenueServicesNet','CapitalLeasesIncomeStatementLeaseRevenue','SalesRevenueGoodsNet','InvestmentAdvisoryFees','InvestmentAdvisoryFees','InvestmentAdvisoryFees','DistributionAndServicingFees','RevenueOtherFinancialServices','RealEstateRevenueNet','FinancialServicesRevenue','RealEstateRevenueNet','OilAndGasRevenue','SalesRevenueNet','InterestAndFeeIncomeLoansAndLeases','OperatingLeasesIncomeStatementLeaseRevenue','FinancialServicesRevenue','SalesRevenueNet','Revenues','UtilityRevenue','RevenueFromRelatedParties','SalesRevenueGoodsNet','RevenueFromRelatedParties','LicensesRevenue','Revenues','OperatingLeasesIncomeStatementContingentRevenue','Revenues')
ORDER BY company_name,
a.name,
p.end_date DESC;
